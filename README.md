# Безопасность интернет-магазина
[пример архитектуры](photo.jpg)
## Архитектура
### Клиенты веб-приложения
Пользователи используют браузеры и мобильные устройства для доступа к сайту, внешние информационные системы взаимодействуют с приложением через API для интеграции с другими платформами.
### Система безопасности и балансировка нагрузки (СЗИ)
Защита от DDoS - первая линия защиты от распределенных атак, направленных на перегрузку сервера.
NGFW (Next-Generation Firewall) - межсетевой экран нового поколения, обеспечивающий контроль трафика и предотвращение сложных атак.
WAF (Web Application Firewall) защищает веб-приложение от атак на уровне приложений, таких как SQL-инъекции или XSS. Балансировщик нагрузки  распределяет входящие запросы между веб-серверами для повышения производительности и надежности.
### Отображение (Frontend)
CDN (Content Delivery Network) используется для ускорения загрузки контента, распределяя его по географически распределенным серверам, веб-серверы принимают запросы от клиентов и передают их на серверы приложений для обработки.
Системы защиты и мониторинга - инструменты, отслеживающие производительность, ошибки и возможные угрозы безопасности в реальном времени.
Логика (Backend)
Серверы приложений обрабатывают запросы на уровне клиентского интерфейса, выполняют бизнес-логику и взаимодействуют с базами данных и кэшированием. API серверы  предоставляют интерфейсы для внешних систем и приложений, взаимодействующих через API.
### Данные
Серверы кэширования используются для временного хранения часто запрашиваемых данных для ускорения работы сайта, серверы баз данных хранят основную информацию о продуктах, пользователях, заказах и других бизнес-процессах.
HSM (Hardware Security Module) - аппаратный модуль для безопасного управления ключами шифрования и другой криптографической информацией.
### Группировка и взаимодействие
Каждый блок логики и данных разделен по бизнес-процессам, что повышает безопасность и устойчивость системы к сбоям. Для наиболее важных операций предусмотрен дополнительный уровень защиты и резервирования.
## Алгоритм работы клиента интернет-магазина техники:
### Подключение к сайту:
Клиент открывает браузер или мобильное приложение и вводит адрес сайта интернет-магазина, запрос в обязательном порядке отправляется через DDoS-защиту.
### Балансировка нагрузки и доступ к веб-серверу:
Запрос проходит через NGFW (Next-Generation Firewall.
Балансировщик нагрузки распределяет запрос между веб-серверами для обработки.
### Отображение сайта:
Веб-сервер обрабатывает запросы и взаимодействует с фронтенд-серверами приложений, которые отвечают за отображение информации на стороне клиента (каталог товаров, описание продуктов). 
### Оформление заказа:
Клиент выбирает товар и оформляет заказ.
Запрос отправляется на backend-серверы приложений, которые обрабатывают бизнес-логику (расчет стоимости, наличие товара, учет скидок и пр.).
### Оплата:
При переходе к оплате, сервер приложения обращается к API серверу для интеграции с платёжной системой или сторонними сервисами.
Для безопасности транзакций используются HSM (аппаратные модули безопасности), которые шифруют данные и защищают платёжные операции.
### Подтверждение заказа:
Сервер кэширования ускоряет процесс подтверждения заказа, сохраняя временные данные.
Backend-сервер взаимодействует с базами данных, проверяя наличие товара, после чего подтверждает заказ и отправляет информацию клиенту.
## Алгоритм работы администратора интернет-магазина техники:
### Аутентификация и доступ к системе:
Администратор подключается к системе через защищенный интерфейс, используя двухфакторную аутентификацию, веб-сервер проверяет его учетные данные через систему безопасности.
### Мониторинг системы:
Администратор получает доступ к панели мониторинга, где отображаются ключевые метрики: состояние веб-серверов, нагрузка на балансировщик, трафик через CDN.
### Управление контентом:
Администратор может добавлять, изменять или удалять информацию о товарах через серверы приложений (frontend/backend), а при изменении информации система кэширования обновляется для ускорения работы сайта.
### Обновление и техническое обслуживание:
Администратор применяет обновления к серверным системам. Все действия в обязательном порядке проходят через системы безопасности для предотвращения внедрения вредоносного кода.
### Управление базами данных:
Администратор проверяет целостность данных на серверах баз данных и проводит резервное копирование.
### Реагирование на инциденты:
При обнаружении инцидентов безопасности администратор должен получать уведомления от системы мониторинга. Далее он анализирует логи, идентифицирует источник угрозы и принимает надлежащие меры по их устранению.
## Три ключевые цели безопасности для интернет-магазина:
### Обеспечение доступности
Цель состоит в обеспечении гарантии того, что сайт интернет-магазина будет доступен для пользователей в любой момент времени, даже в условиях внешних угроз. 
### Конфиденциальность данных клиентов
Цель состоит в защите личных и платежных данных пользователей от несанкционированного доступа и утечек.
### Целостность данных и систем
Цель: гарантировать, что данные и системы интернет-магазина остаются неизменными и защищены от манипуляций, как со стороны злоумышленников, так и в результате внутренних ошибок.
## Угрозы
| **Тип Уязвимости**                                     | **Риск**  | **Количество** | **% от общего** |
|--------------------------------------------------------|-----------|----------------|-----------------|
| Раскрытие PII                                           | Высокий   | 1              | (2,7 %)         |
| CSP: Директива подстановочного знака                   | Средний   | 1              | (2,7 %)         |
| Заголовок Content Security Policy (CSP) не задан       | Средний   | 1205           | (3 256,8 %)     |
| Идентификатор (ID) сеанса при перезаписи URL           | Средний   | 18             | (48,6 %)        |
| Междоменная неправильная конфигурация                  | Средний   | 29             | (78,4 %)        |
| Отсутствует заголовок (Header) для защиты от кликджекинга | Средний   | 280            | (756,8 %)       |
| Отсутствуют токены против CSRF атак                    | Средний   | 68             | (183,8 %)       |
| Раскрытие ошибок приложения                            | Средний   | 1              | (2,7 %)         |
| Уязвимость JS Библиотеки (Library)                     | Средний   | 1              | (2,7 %)         |
| CSP: Уведомления                                        | Низкий    | 1              | (2,7 %)         |
| Cookie No HttpOnly Flag                                | Низкий    | 1090           | (2 945,9 %)     |
| Cookie без атрибута SameSite                           | Низкий    | 1076           | (2 908,1 %)     |
| Cookie без флажка безопасности                         | Низкий    | 887            | (2 397,3 %)     |
| Cookie с атрибутом SameSite нет                        | Низкий    | 34             | (91,9 %)        |
| Включение исходного файла междоменного JavaScript      | Низкий    | 7217           | (19 505,4 %)    |
| Заголовок Strict-Transport-Security не установлен      | Низкий    | 1322           | (3 573,0 %)     |
| Заголовок X-Content-Type-Options отсутствует           | Низкий    | 345            | (932,4 %)       |
| Защищенные страницы содержат смешанный контент         | Низкий    | 1              | (2,7 %)         |
| Множественные записи заголовков Strict-Transport-Security (несовместимы со спецификацией) | Низкий | 1 | (2,7 %) |
| Обнаружена Большая Переадресация (Потенциальная Утечка Конфиденциальной Информации) | Низкий | 16 | (43,2 %) |
| Раскрытие информации - сообщения об ошибках отладки    | Низкий    | 1              | (2,7 %)         |
| Раскрытие отметки времени - Unix                       | Низкий    | 287            | (775,7 %)       |
| Раскрытие ошибок приложения                            | Низкий    | 2              | (5,4 %)         |
| Раскрытие частной ИС                                   | Низкий    | 129            | (348,6 %)       |
| Сервер утекает информацию через поля заголовка HTTP-ответа "X-Powered-By" | Низкий | 153 | (413,5 %) |
| Сервер утечка информации о версии через поле заголовка HTTP-ответа «Server» | Низкий | 25 | (67,6 %) |
| Authentication Request Identified                      | Информационный | 17         | (45,9 %)        |
| Cookie с произвольным ограничением                     | Информационный | 457        | (1 235,1 %)     |
| Session Management Response Identified                 | Информационный | 459        | (1 240,5 %)     |
| Атрибут элемента HTML, управляемый пользователем (потенциальный XSS) | Информационный | 290 | (783,8 %) |
| Заголовок Content-Type отсутствует                     | Информационный | 13         | (35,1 %)        |
| Отравление Cookie                                      | Информационный | 1          | (2,7 %)         |
| Пересмотрите директивы управления кэшем                | Информационный | 132        | (356,8 %)       |
| Получено из кеша                                       | Информационный | 33         | (89,2 %)        |
| Раскрытие информации - конфиденциальная информация в URL | Информационный | 40         | (108,1 %)       |
| Раскрытие информации - подозрительные комментарии      | Информационный | 224        | (605,4 %)       |
| Современное веб-приложение                             | Информационный | 503        | (1 359,5 %)     |
### Защита личных данных (PII): 
- Последствия:  
Злоумышленник создает очень стойкий файл cookie, который сохраняется даже после того, как пользователь считает его удаленным. Cookie хранится на компьютере жертвы в более чем десяти местах. Когда жертва очищает кэш cookie традиционными средствами в браузере, эта операция удаляет cookie из определенных мест, но не из других. Затем вредоносный код снова копирует cookie из всех мест, где он не был удален, во все возможные места хранения. Таким образом, жертва снова получает куки во всех исходных местах хранения. Другими словами, если куки не удалены даже в одном месте, они будут сохранены везде. Кроме того, evercookie будет сохраняться в разных браузерах, поскольку некоторые хранилища (например, Local Shared Objects) являются общими для разных браузеров.  
Злоумышленник собирает идентифицирующую информацию о жертве через активную сессию браузера жертвы с социальной сетью. Жертва может держать сайт социальной сети открытым на одной вкладке или просто использовать функцию «запомнить меня» для поддержания активной сессии с сайтом социальной сети. Злоумышленник вызывает выполнение полезной нагрузки в браузере жертвы, которая незаметно для жертвы инициирует запрос к сайту социальной сети (например, через доступные API сайта социальной сети) для получения идентифицирующей информации о жертве. Хотя часть этой информации может быть общедоступной, злоумышленник может собрать эту информацию в контексте и использовать ее для дальнейших атак на пользователя (например, spear phishing).  
Злоумышленник изучает снимки экрана, созданные iOS, в попытке получить конфиденциальную информацию. Эта атака направлена на временные скриншоты, создаваемые базовой ОС, пока приложение остается открытым в фоновом режиме.    
При атаке с использованием «плечевого серфинга» противник наблюдает за нажатием клавиш, содержимым экрана или разговорами неосведомленного человека с целью получения конфиденциальной информации. Одним из мотивов такой атаки является получение конфиденциальной информации о цели для получения финансовой, личной, политической или иной выгоды. С точки зрения внутренней угрозы, дополнительным мотивом может быть получение учетных данных системы/приложения или криптографических ключей. Атаки «через плечо» осуществляются путем просмотра содержимого «через плечо» жертвы, что следует из названия этой атаки.  
- Стратегия
Удаление метода GET, привязали его к методу POST и добавили заголовок токена авторизации в вышеупомянутый запрос метода POST, где каждый раз он будет аутентифицироваться с сервера.
Это позволило избавиться от возможности повторить описанный выше сценарий — атака с копированием персональных данных пользователя через API.
### CSP: Директива подстановочного знака (Wildcard Directive)
- Последствия:   
В процессе разбора данных внедренный элемент может заставить процесс выполнить неожиданные действия.  
Три стратегии борьбы:
- Стратегия: Валидация ввода  
Предположите, что все вводимые данные являются вредоносными. Используйте стратегию проверки входных данных по принципу «принимай заведомо исправные», т. е. используйте список допустимых входных данных, строго соответствующих спецификациям. Отклоняйте любые входные данные, которые не соответствуют спецификациям, или преобразуйте их в то, что соответствует.
При проверке ввода учитывайте все потенциально значимые свойства, включая длину, тип ввода, полный диапазон допустимых значений, отсутствующие или лишние вводы, синтаксис, согласованность между смежными полями и соответствие бизнес-правилам. В качестве примера логики бизнес-правил можно привести синтаксис слова «лодка», поскольку оно содержит только буквенно-цифровые символы, но оно не будет корректным, если ожидается, что вводимые данные будут содержать только цвета, такие как «красный» или «синий».
Не стоит полагаться только на поиск вредоносных или неправильно сформированных входных данных. Это может привести к пропуску хотя бы одного нежелательного ввода, особенно если окружение кода изменится. Это может дать злоумышленникам достаточно возможностей, чтобы обойти намеченную проверку. Тем не менее, списки отрицаний могут быть полезны для обнаружения потенциальных атак или определения того, какие вводимые данные настолько недоброкачественны, что их следует сразу отвергать.
- Стратегия: Кодирование выходных данных  
Хотя использовать динамически генерируемые строки запросов, код или команды, в которых смешиваются элементы управления и данные, довольно рискованно, иногда это может быть неизбежно. Правильно заключайте аргументы в кавычки и экранируйте все специальные символы в этих аргументах. Наиболее консервативным подходом является удаление или фильтрация всех символов, которые не проходят по очень строгому списку разрешений (например, все, что не является алфавитно-цифровыми символами или белым пробелом). Если некоторые специальные символы все же необходимы, например пробел, оберните каждый аргумент в кавычки после этапа экранирования/фильтрации. Будьте осторожны с инъекцией аргументов (CWE-88).
- Стратегия: Валидация ввода  
Перед проверкой входные данные должны быть декодированы и канонизированы в соответствии с текущим внутренним представлением приложения (CWE-180). Убедитесь, что приложение не декодирует один и тот же входной сигнал дважды (CWE-174). Такие ошибки могут быть использованы для обхода схем проверки списков разрешений путем введения опасных входных данных после их проверки.
### Заголовок Content Security Policy (CSP) не задан
- Определение правила  
Одним из способов защиты сайта от XSS является ограничение веб-доменов, с которых могут обслуживаться скрипты, что возможно благодаря заголовкам Content Security Policy (CSP). CSP-заголовки позволяют серверу указать браузеру принимать содержимое только из определенных доменов, например, safedomain.com. Заголовок 'Content-Security-Policy' может ограничивать источник всего содержимого или только определенных типов, таких как изображения, медиа и скрипты.
- Устранение проблемы  
Включите заголовок CSP в XML-конфигурации и конфигурации JAVA с помощью элемента «the content-security-policy».
### Идентификатор (ID) сеанса при перезаписи URL
- Фаза: Архитектура и дизайн  
Перед авторизацией нового пользовательского сеанса аннулируйте все существующие идентификаторы сеанса.
- Этап: Архитектура и дизайн  
Для таких платформ, как ASP, которые не генерируют новые значения для файлов cookie sessionid, используйте вторичный файл cookie. При таком подходе установите в браузере пользователя вторичный cookie на случайное значение и установите переменную сеанса на то же значение. Если переменная сеанса и значение cookie не совпадают, аннулируйте сеанс и заставьте пользователя войти в систему снова.
### Междоменная неправильная конфигурация
- Стратегия: Сокращение поверхности атаки  
Избегайте использования подстановочных знаков в файле междоменной политики. Любой домен, соответствующий выражению с подстановочным знаком, будет неявно доверенным и сможет осуществлять двустороннее взаимодействие с целевым сервером.
- Стратегия: Усиление среды  
Для Flash измените файл crossdomain.xml, чтобы использовать такие параметры метаполитики, как 'master-only' или 'none', чтобы уменьшить вероятность того, что злоумышленник установит на сервер посторонние файлы политики кросс-домена.
- Стратегия: Сокращение поверхности атаки  
Для Flash измените файл crossdomain.xml, чтобы использовать такие параметры метаполитики, как 'master-only' или 'none', чтобы уменьшить вероятность установки злоумышленником посторонних файлов политики кросс-домена на сервер.
###  Отсутствует заголовок (Header) для защиты от кликджекинга
Современные веб-браузеры поддерживают HTTP-заголовки Content-Security-Policy и X-Frame-Options. Убедитесь, что один из них установлен на всех веб-страницах, возвращаемых вашим сайтом/приложением. Если вы ожидаете, что страница будет обрамлена только страницами на вашем сервере (например, она является частью FRAMESET), то вам следует использовать SAMEORIGIN, в противном случае, если вы никогда не ожидаете, что страница будет обрамлена, вам следует использовать DENY. В качестве альтернативы рассмотрите возможность применения директивы «frame-ancestors» в Content Security Policy.
### Отсутствуют токены против CSRF атак
Последствия зависят от характера функциональности, уязвимой для CSRF. Злоумышленник может эффективно выполнять любые операции на месте жертвы. Если жертва является администратором или привилегированным пользователем, последствия могут включать получение полного контроля над веб-приложением - удаление или кражу данных, деинсталляцию продукта или использование его для запуска других атак против всех пользователей продукта. Поскольку злоумышленник обладает идентификационными данными жертвы, масштаб CSRF ограничивается только ее привилегиями.
### Раскрытие ошибок приложения
Последствия: Часто это приводит либо к раскрытию конфиденциальной информации, которая может быть использована для последующей атаки, либо к раскрытию частной информации, хранящейся на сервере.
Убедитесь, что сообщения об ошибках содержат только минимальную информацию, полезную только для целевой аудитории и ни для кого больше. В сообщениях должен быть соблюден баланс между слишком загадочными (что может запутать пользователей) и слишком подробными (что может раскрыть больше, чем предполагалось). Сообщения не должны раскрывать методы, которые использовались для определения ошибки. Злоумышленники могут использовать подробную информацию для доработки или оптимизации своей первоначальной атаки, тем самым увеличивая свои шансы на успех.
Если ошибки должны быть зафиксированы с некоторыми подробностями, записывайте их в сообщения журнала, но подумайте о том, что может произойти, если сообщения журнала могут быть просмотрены злоумышленниками. Никогда не сохраняйте в лог-файлах особо важную информацию, например пароли.
Избегайте непоследовательных сообщений, которые могут случайно выдать злоумышленнику внутреннее состояние, например, существует ли учетная запись пользователя или нет.
Обрабатывайте исключения внутри системы и не показывайте пользователю ошибки, содержащие потенциально конфиденциальную информацию.
- Стратегия: Сокращение поверхности атаки  
Используйте соглашения об именовании и строгие типы, чтобы было легче определить, когда используются конфиденциальные данные. При создании структур, объектов и других сложных сущностей максимально разделяйте конфиденциальные и не конфиденциальные данные.  
Эффективность: Глубинная защита  
Примечание: Это облегчает обнаружение мест в коде, где используются незашифрованные данные.
- Стратегия: Компиляция или усиление сборки  
Отладочная информация не должна попадать в производственный релиз.
- Стратегия: Усиление среды  
Отладочная информация не должна попадать в производственный релиз.
Там, где это возможно, настройте среду на использование менее подробных сообщений об ошибках. Например, в PHP отключите параметр display_errors во время настройки или во время выполнения с помощью функции error_reporting().  
Создайте страницы или сообщения об ошибках по умолчанию, которые не передают никакой информации.
### Уязвимость JS Библиотеки (Library)
Регулярное обновление библиотек:  
Используйте инструменты для автоматического мониторинга уязвимостей в зависимостях, такие как npm audit, Snyk или аналогичные для вашего фреймворка.
Регулярно обновляйте библиотеки до последних стабильных версий и избегайте использования библиотек, которые не поддерживаются.
### CSP: Уведомления
Настройка уведомлений CSP:  
Используйте директиву report-uri в политике безопасности контента для отправки уведомлений о нарушениях:  
Эти уведомления помогут оперативно выявлять и реагировать на попытки атак или нарушения политики безопасности.
Мониторинг уведомлений:   
Настройте сервер для приема и обработки уведомлений о нарушениях CSP, чтобы вовремя устранять проблемы и предотвращать потенциальные атаки.
## Список используемых литератур
- https://habr.com/ru/companies/simplepay/articles/258499/
- https://owasp.org/Top10/
- https://cwe.mitre.org/
- https://www.zaproxy.org/getting-started/
